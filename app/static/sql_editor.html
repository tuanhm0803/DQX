<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQ Rule Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/monokai.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background: linear-gradient(120deg, #d9fffa 0%, #e0e7ff 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .editor-container, .script-list {
            background: rgba(255,255,255,0.85);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.18);
            padding: 20px;
            margin-bottom: 20px;
            transition: box-shadow 0.3s, transform 0.3s;
        }
        .editor-container:hover, .script-list:hover {
            box-shadow: 0 16px 40px 0 rgba(31, 38, 135, 0.22);
            transform: translateY(-2px) scale(1.01);
        }
        .btn, .btn-primary, .btn-success, .btn-danger, .btn-outline-secondary, .btn-outline-success {
            border-radius: 8px !important;
            transition: box-shadow 0.2s, background 0.2s, color 0.2s;
        }
        .btn:hover, .btn:focus {
            box-shadow: 0 2px 8px rgba(57, 149, 211, 0.15);
            filter: brightness(1.07);
        }
        .CodeMirror {
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            background: rgba(255,255,255,0.95);
        }
        .result-container {
            background: rgba(255,255,255,0.92);
            border-radius: 16px;
            box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.10);
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .script-item {
            cursor: pointer;
            padding: 8px;
            border-bottom: 1px solid #eee;
            border-radius: 6px;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .script-item:hover {
            background: #e0f7fa;
            box-shadow: 0 2px 8px rgba(57, 149, 211, 0.08);
        }
        .table-responsive {
            max-height: 300px;
            overflow-y: auto;
        }
        .actions-column {
            min-width: 100px;
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-4 text-end">
        <a href="/" class="btn btn-outline-primary" style="border-radius: 8px;">
            <i class="bi bi-house-door"></i> Back to Main Page
        </a>
    </div>
    <div class="container">
        <h1 class="mb-4">DQ Rule Editor</h1>

        <div class="row">
            <!-- Unified Block: Script List and Editor -->
            <div class="col-md-4">
                <div class="script-list mb-3">
                    <h5>Saved Scripts</h5>
                    <div class="list-group" id="scriptsList">
                        <!-- Script items will be loaded here -->
                    </div>
                </div>
                <div class="d-grid">
                    <button class="btn btn-primary" id="btnNewScript">New Script</button>
                </div>
            </div>

            <div class="col-md-8">
                <div class="editor-container">
                    <div class="mb-3">
                        <label for="scriptName" class="form-label">Script Name</label>
                        <input type="text" class="form-control" id="scriptName" placeholder="Enter script name">
                    </div>
                    <div class="mb-3">
                        <label for="scriptDescription" class="form-label">Description (optional)</label>
                        <input type="text" class="form-control" id="scriptDescription" placeholder="Enter description">
                    </div>
                    <div class="mb-3">
                        <label for="sqlEditor" class="form-label">SQL Script</label>
                        <textarea id="sqlEditor"></textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div>
                            <button class="btn btn-primary me-2" id="btnExecute">Execute</button>
                            <button class="btn btn-success me-2" id="btnSave">Save</button>
                        </div>
                        <div>
                            <button class="btn btn-danger" id="btnDelete" style="display: none;">Delete</button>
                        </div>
                    </div>
                </div>

                <div class="result-container" id="resultContainer" style="display: none;">
                    <h5>Results</h5>
                    <div id="resultContent">
                        <div class="table-responsive">
                            <table class="table table-striped" id="resultTable">
                                <thead>
                                    <tr>
                                        <th>Column Name</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody id="resultTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for messages -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Message content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/sql/sql.min.js"></script>
    <script>
        // Initialize variables
        let currentScriptId = null;
        const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
        
        // Centralized response handler
        async function handleResponse(response) {
            if (response.ok) {
                // If the response is a 204 No Content, we don't need to parse JSON
                if (response.status === 204) {
                    return null;
                }
                return response.json();
            }
            const errorText = await response.text();
            try {
                // Try to parse the error text as JSON, as our API should return JSON errors
                const errorJson = JSON.parse(errorText);
                throw new Error(errorJson.detail || 'An unknown server error occurred.');
            } catch (e) {
                // If it's not JSON, it might be an HTML error page. Show a snippet.
                const snippet = errorText.substring(0, 300);
                throw new Error(`Server returned a non-JSON response: ${snippet}`);
            }
        }

        // Initialize CodeMirror
        const sqlEditor = CodeMirror.fromTextArea(document.getElementById('sqlEditor'), {
            mode: 'text/x-sql',
            theme: 'monokai',
            lineNumbers: true,
            indentWithTabs: true,
            smartIndent: true,
            lineWrapping: true,
            matchBrackets: true,
            autofocus: true
        });        // Load all scripts when the page loads
        window.onload = function() {
            loadScripts();
            
            // Check for preloaded query from index page
            const preloadedQuery = localStorage.getItem('preloadedQuery');
            if (preloadedQuery) {
                sqlEditor.setValue(preloadedQuery);
                localStorage.removeItem('preloadedQuery'); // Clear after loading
            }
            
            // Check for preload table parameter
            const urlParams = new URLSearchParams(window.location.search);
            const preloadTable = urlParams.get('preloadTable');
            if (preloadTable) {
                document.getElementById('scriptName').value = `${preloadTable} Query`;
            }
        };

        // Function to load all saved scripts
        function loadScripts() {
            fetch('/scripts/')
                .then(handleResponse)
                .then(scripts => {
                    const scriptsList = document.getElementById('scriptsList');
                    scriptsList.innerHTML = '';
                    
                    if (scripts.length === 0) {
                        scriptsList.innerHTML = '<div class="list-group-item">No scripts found</div>';
                        return;
                    }
                    
                    scripts.forEach(script => {
                        const scriptItemContainer = document.createElement('div');
                        scriptItemContainer.className = 'd-flex justify-content-between align-items-center list-group-item';

                        const scriptNameButton = document.createElement('button');
                        scriptNameButton.className = 'btn btn-link text-start flex-grow-1 p-0';
                        scriptNameButton.textContent = script.name;
                        scriptNameButton.onclick = () => loadScript(script.id);

                        const populateButton = document.createElement('button');
                        populateButton.className = 'btn btn-sm btn-outline-secondary me-2'; // Added margin
                        populateButton.textContent = 'Populate';
                        populateButton.onclick = (e) => {
                            e.stopPropagation(); // Prevent triggering loadScript
                            populateTable(script.id);
                        };

                        const publishButton = document.createElement('button');
                        publishButton.className = 'btn btn-sm btn-outline-success';
                        publishButton.textContent = 'Publish';
                        publishButton.onclick = (e) => {
                            e.stopPropagation();
                            publishResults(script.id);
                        };

                        scriptItemContainer.appendChild(scriptNameButton);
                        
                        const buttonGroup = document.createElement('div');
                        buttonGroup.appendChild(populateButton);
                        buttonGroup.appendChild(publishButton);

                        scriptItemContainer.appendChild(buttonGroup);
                        scriptsList.appendChild(scriptItemContainer);
                    });
                })
                .catch(error => {
                    console.error('Failed to load scripts:', error);
                    showMessage('Error', 'Failed to load scripts: ' + error.message)
                });
        }

        // Function to load a specific script
        function loadScript(scriptId) {
            fetch(`/scripts/${scriptId}`)
                .then(handleResponse)
                .then(script => {
                    currentScriptId = script.id;
                    document.getElementById('scriptName').value = script.name;
                    document.getElementById('scriptDescription').value = script.description || '';
                    sqlEditor.setValue(script.content);
                    document.getElementById('btnDelete').style.display = 'block';
                })
                .catch(error => showMessage('Error', 'Failed to load script: ' + error.message));
        }

        // Function to populate the staging table for a script
        function populateTable(scriptId) {
            // Show a loading indicator or disable the button
            showMessage('In Progress', `Populating table for script ${scriptId}...`);

            fetch(`/scripts/${scriptId}/populate_table`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(handleResponse)
            .then(result => {
                showMessage('Success', `Successfully inserted ${result.inserted_rows} rows into ${result.table}.`);
            })
            .catch(error => {
                showMessage('Error', `Failed to populate table: ${error.message}`);
            });
        }

        // Function to publish results to the bad_detail table
        function publishResults(scriptId) {
            if (!confirm(`Are you sure you want to publish the results for script ${scriptId}? This will replace existing data for the associated rule.`)) {
                return;
            }

            showMessage('In Progress', `Publishing results for script ${scriptId}...`);

            fetch(`/scripts/${scriptId}/publish`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(handleResponse)
            .then(result => {
                showMessage('Success', `Successfully published ${result.published_rows} rows for rule_id: ${result.rule_id}.`);
            })
            .catch(error => {
                showMessage('Error', `Failed to publish results: ${error.message}`);
            });
        }

        // Function to execute SQL script
        document.getElementById('btnExecute').addEventListener('click', function() {
            const scriptContent = sqlEditor.getValue();
            
            if (!scriptContent.trim()) {
                showMessage('Warning', 'Please enter an SQL script to execute.');
                return;
            }
            
            // Show loading indicator
            document.getElementById('resultContainer').style.display = 'block';
            document.getElementById('resultContent').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
              // Send request to execute script
            fetch('/scripts/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ script_content: scriptContent })
            })
            .then(handleResponse)
            .then(result => {
                console.log('Execution result:', result);
                displayResults(result);
            })
            .catch(error => {
                console.error('Execution error:', error);
                const errorMsg = error.message || 'Unknown error occurred';
                showMessage('Error', 'Failed to execute script: ' + errorMsg);
                
                // Also update the result container with the error
                document.getElementById('resultContainer').style.display = 'block';
                document.getElementById('resultContent').innerHTML = 
                    `<div class="alert alert-danger">Error executing script: ${errorMsg}</div>`;
            });
        });

        // Function to save script
        document.getElementById('btnSave').addEventListener('click', function() {
            const name = document.getElementById('scriptName').value;
            const description = document.getElementById('scriptDescription').value;
            const content = sqlEditor.getValue();
            
            if (!name.trim()) {
                showMessage('Warning', 'Please enter a name for the script.');
                return;
            }
            
            if (!content.trim()) {
                showMessage('Warning', 'Please enter an SQL script to save.');
                return;
            }
            
            const scriptData = {
                name: name,
                description: description,
                content: content
            };
            
            const method = currentScriptId ? 'PUT' : 'POST';
            const url = currentScriptId ? `/scripts/${currentScriptId}` : '/scripts/';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(scriptData)
            })
            .then(handleResponse)
            .then(script => {
                currentScriptId = script.id;
                document.getElementById('btnDelete').style.display = 'block';
                showMessage('Success', `Script ${currentScriptId ? 'updated' : 'saved'} successfully!`);
                loadScripts();
            })
            .catch(error => showMessage('Error', `Failed to ${currentScriptId ? 'update' : 'save'} script: ` + error.message));
        });

        // Function to delete script
        document.getElementById('btnDelete').addEventListener('click', function() {
            if (!currentScriptId) {
                return;
            }
            
            if (!confirm('Are you sure you want to delete this script?')) {
                return;
            }
            
            fetch(`/scripts/${currentScriptId}`, {
                method: 'DELETE'
            })
            .then(handleResponse)
            .then(result => {
                showMessage('Success', 'Script deleted successfully!');
                resetEditor();
                loadScripts();
            })
            .catch(error => showMessage('Error', 'Failed to delete script: ' + error.message));
        });

        // Function to create a new script
        document.getElementById('btnNewScript').addEventListener('click', function() {
            resetEditor();
        });

        // Function to reset the editor
        function resetEditor() {
            currentScriptId = null;
            document.getElementById('scriptName').value = '';
            document.getElementById('scriptDescription').value = '';
            sqlEditor.setValue('');
            document.getElementById('btnDelete').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'none';
        }        // Function to display results of SQL execution
        function displayResults(result) {
            const resultContainer = document.getElementById('resultContainer');
            const resultContent = document.getElementById('resultContent');
            resultContainer.style.display = 'block';
            
            // Helper function to escape HTML special characters
            function escapeHtml(unsafe) {
                if (unsafe === null) return 'NULL';
                if (unsafe === undefined) return '';
                return String(unsafe)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
            
            if (result.message) {
                if (result.data && result.data.length > 0) {
                    // Build HTML for the table directly
                    let tableHTML = '<div class="alert alert-success mb-3">' + escapeHtml(result.message) + ' (' + result.count + ' rows)</div>';
                    tableHTML += '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                    
                    // Add headers
                    Object.keys(result.data[0]).forEach(key => {
                        tableHTML += '<th>' + escapeHtml(key) + '</th>';
                    });
                    
                    tableHTML += '</tr></thead><tbody>';
                    
                    // Add data rows
                    result.data.forEach(row => {
                        tableHTML += '<tr>';
                        Object.values(row).forEach(value => {
                            tableHTML += '<td>' + escapeHtml(value) + '</td>';
                        });
                        tableHTML += '</tr>';
                    });
                    
                    tableHTML += '</tbody></table></div>';
                    
                    // Set the HTML all at once
                    resultContent.innerHTML = tableHTML;
                } else {
                    // Show message for non-query statements
                    resultContent.innerHTML = '<div class="alert alert-success">' + escapeHtml(result.message) + 
                        (result.affected_rows !== undefined ? ' (' + escapeHtml(result.affected_rows) + ' rows affected)' : '') + 
                        '</div>';
                }
            } else {
                resultContent.innerHTML = '<div class="alert alert-warning">No results returned</div>';
            }
        }

        // Function to show message modal
        function showMessage(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').textContent = message;
            messageModal.show();
        }
    </script>
</body>
</html>